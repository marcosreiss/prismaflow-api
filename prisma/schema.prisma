datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Tenant {
  id                  String               @id @default(cuid())
  name                String
  branches            Branch[]
  users               User[]
  brands              Brand[]
  products            Product[]
  createdById         String?
  updatedById         String?
  createdBy           User?                @relation("TenantCreatedBy", fields: [createdById], references: [id])
  updatedBy           User?                @relation("TenantUpdatedBy", fields: [updatedById], references: [id])
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  OpticalService      OpticalService[]
  Client              Client[]
  Prescription        Prescription[]
  sales               Sale[]
  protocols           Protocol[]
  itemProducts        ItemProduct[]
  frameDetails        FrameDetails[]
  itemOpticalServices ItemOpticalService[]
  payments            Payment[]
  paymentInstallments PaymentInstallment[]
}

model Branch {
  id                  String               @id @default(cuid())
  name                String
  tenantId            String
  tenant              Tenant               @relation(fields: [tenantId], references: [id])
  users               User[]
  createdById         String?
  updatedById         String?
  createdBy           User?                @relation("BranchCreatedBy", fields: [createdById], references: [id])
  updatedBy           User?                @relation("BranchUpdatedBy", fields: [updatedById], references: [id])
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  Product             Product[]
  OpticalService      OpticalService[]
  Client              Client[]
  Prescription        Prescription[]
  sales               Sale[]
  protocols           Protocol[]
  itemProducts        ItemProduct[]
  frameDetails        FrameDetails[]
  itemOpticalServices ItemOpticalService[]
  payments            Payment[]
  paymentInstallments PaymentInstallment[]

  @@unique([tenantId, name], name: "branch_name_per_tenant_unique")
}

model User {
  id       String  @id @default(cuid())
  name     String
  email    String  @unique
  password String
  role     Role
  tenantId String
  tenant   Tenant  @relation(fields: [tenantId], references: [id])
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id])

  // ðŸ”¹ Auditoria
  createdById String?
  updatedById String?
  createdBy   User?   @relation("UserCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("UserUpdatedBy", fields: [updatedById], references: [id])

  // ðŸ”¹ RelaÃ§Ãµes inversas
  tenantsCreated                 Tenant[]             @relation("TenantCreatedBy")
  tenantsUpdated                 Tenant[]             @relation("TenantUpdatedBy")
  branchesCreatedByMe            Branch[]             @relation("BranchCreatedBy")
  branchesUpdatedByMe            Branch[]             @relation("BranchUpdatedBy")
  usersCreatedByMe               User[]               @relation("UserCreatedBy")
  usersUpdatedByMe               User[]               @relation("UserUpdatedBy")
  brandsCreatedByMe              Brand[]              @relation("BrandCreatedBy")
  brandsUpdatedByMe              Brand[]              @relation("BrandUpdatedBy")
  productsCreatedByMe            Product[]            @relation("ProductCreatedBy")
  productsUpdatedByMe            Product[]            @relation("ProductUpdatedBy")
  servicesCreatedByMe            OpticalService[]     @relation("ServiceCreatedBy")
  servicesUpdatedByMe            OpticalService[]     @relation("ServiceUpdatedBy")
  clientsCreatedByMe             Client[]             @relation("ClientCreatedBy")
  clientsUpdatedByMe             Client[]             @relation("ClientUpdatedBy")
  prescriptionsCreatedByMe       Prescription[]       @relation("PrescriptionCreatedBy")
  prescriptionsUpdatedByMe       Prescription[]       @relation("PrescriptionUpdatedBy")
  salesCreatedByMe               Sale[]               @relation("SaleCreatedBy")
  salesUpdatedByMe               Sale[]               @relation("SaleUpdatedBy")
  protocolsCreatedByMe           Protocol[]           @relation("ProtocolCreatedBy")
  protocolsUpdatedByMe           Protocol[]           @relation("ProtocolUpdatedBy")
  itemProductsCreatedByMe        ItemProduct[]        @relation("ItemProductCreatedBy")
  itemProductsUpdatedByMe        ItemProduct[]        @relation("ItemProductUpdatedBy")
  frameDetailsCreatedByMe        FrameDetails[]       @relation("FrameDetailsCreatedBy")
  frameDetailsUpdatedByMe        FrameDetails[]       @relation("FrameDetailsUpdatedBy")
  itemOpticalServicesCreatedByMe ItemOpticalService[] @relation("ItemOpticalServiceCreatedBy")
  itemOpticalServicesUpdatedByMe ItemOpticalService[] @relation("ItemOpticalServiceUpdatedBy")
  paymentsCreatedByMe            Payment[]            @relation("PaymentCreatedBy")
  paymentsUpdatedByMe            Payment[]            @relation("PaymentUpdatedBy")
  paymentInstallmentsCreatedByMe PaymentInstallment[] @relation("PaymentInstallmentCreatedBy")
  paymentInstallmentsUpdatedByMe PaymentInstallment[] @relation("PaymentInstallmentUpdatedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Brand {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  isActive Boolean   @default(true)
  tenantId String
  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  products Product[]

  // ðŸ”¹ Auditoria
  createdById String?
  updatedById String?
  createdBy   User?   @relation("BrandCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("BrandUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id            Int             @id @default(autoincrement())
  name          String
  description   String?
  costPrice     Float?
  markup        Float?
  salePrice     Float?
  stockQuantity Int?            @default(0)
  minimumStock  Int?            @default(0)
  category      ProductCategory
  isActive      Boolean         @default(true)

  tenantId String
  tenant   Tenant  @relation(fields: [tenantId], references: [id])
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id])
  brandId  Int?
  brand    Brand?  @relation(fields: [brandId], references: [id])

  // ðŸ”¹ Auditoria
  createdById String?
  updatedById String?
  createdBy   User?   @relation("ProductCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("ProductUpdatedBy", fields: [updatedById], references: [id])

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  ItemProduct ItemProduct[]
}

model OpticalService {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  price       Float
  isActive    Boolean @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  createdById String?
  updatedById String?
  createdBy   User?   @relation("ServiceCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("ServiceUpdatedBy", fields: [updatedById], references: [id])

  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  ItemOpticalService ItemOpticalService[]
}

model Client {
  id            Int       @id @default(autoincrement())
  name          String
  nickname      String?
  cpf           String?   @unique
  rg            String?
  bornDate      DateTime?
  gender        Gender?
  fatherName    String?
  motherName    String?
  spouse        String?
  email         String?
  company       String?
  occupation    String?
  street        String?
  number        String?
  neighborhood  String?
  city          String?
  uf            String?
  cep           String?
  complement    String?
  isBlacklisted Boolean?  @default(false)
  obs           String?
  phone01       String?
  phone02       String?
  phone03       String?
  reference01   String?
  reference02   String?
  reference03   String?
  isActive      Boolean   @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  prescriptions Prescription[]

  createdById String?
  updatedById String?
  createdBy   User?   @relation("ClientCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("ClientUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Sale      Sale[]
}

model Prescription {
  id Int @id @default(autoincrement())

  clientId Int
  client   Client @relation(fields: [clientId], references: [id])

  prescriptionDate DateTime

  doctorName String?
  crm        String?

  // Olho Direito (OD)
  odSpherical   String?
  odCylindrical String?
  odAxis        String?
  odDnp         String?

  // Olho Esquerdo (OE)
  oeSpherical   String?
  oeCylindrical String?
  oeAxis        String?
  oeDnp         String?

  // Valores independentes
  additionRight      String?
  additionLeft       String?
  opticalCenterRight String?
  opticalCenterLeft  String?

  isActive Boolean @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  createdById String?
  updatedById String?
  createdBy   User?   @relation("PrescriptionCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("PrescriptionUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ðŸ”¹ RelaÃ§Ã£o inversa (1:N)
  sales Sale[]
}

model Sale {
  id       Int    @id @default(autoincrement())
  clientId Int
  client   Client @relation(fields: [clientId], references: [id])

  // ðŸ”¹ Nova coluna (opcional)
  prescriptionId Int?
  prescription   Prescription? @relation(fields: [prescriptionId], references: [id])

  // Relacionamentos existentes
  protocol     Protocol?            @relation("SaleProtocol")
  productItems ItemProduct[]
  serviceItems ItemOpticalService[]
  payment      Payment?             @relation("SalePayment")

  subtotal Float?  @default(0)
  discount Float?  @default(0)
  total    Float?  @default(0)
  notes    String?
  isActive Boolean @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  createdById String?
  updatedById String?
  createdBy   User?   @relation("SaleCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("SaleUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ItemProduct {
  id        Int     @id @default(autoincrement())
  saleId    Int
  sale      Sale    @relation(fields: [saleId], references: [id])
  productId Int
  product   Product @relation(fields: [productId], references: [id])

  quantity     Int           @default(1)
  frameDetails FrameDetails?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  createdById String?
  updatedById String?
  createdBy   User?   @relation("ItemProductCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("ItemProductUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FrameDetails {
  id            Int               @id @default(autoincrement())
  itemProductId Int               @unique
  itemProduct   ItemProduct       @relation(fields: [itemProductId], references: [id])
  material      FrameMaterialType
  reference     String?
  color         String?
  isActive      Boolean           @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  createdById String?
  updatedById String?
  createdBy   User?   @relation("FrameDetailsCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("FrameDetailsUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ItemOpticalService {
  id        Int            @id @default(autoincrement())
  saleId    Int
  sale      Sale           @relation(fields: [saleId], references: [id])
  serviceId Int
  service   OpticalService @relation(fields: [serviceId], references: [id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  createdById String?
  updatedById String?
  createdBy   User?   @relation("ItemOpticalServiceCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("ItemOpticalServiceUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payment {
  id                Int            @id @default(autoincrement())
  saleId            Int            @unique
  sale              Sale           @relation("SalePayment", fields: [saleId], references: [id])
  method            PaymentMethod?
  status            PaymentStatus  @default(PENDING)
  total             Float          @default(0)
  discount          Float          @default(0)
  downPayment       Float          @default(0)
  installmentsTotal Int?
  paidAmount        Float          @default(0)
  installmentsPaid  Int            @default(0)
  lastPaymentAt     DateTime?
  firstDueDate      DateTime?
  isActive          Boolean        @default(true)

  // ðŸ”¹ Relacionamento com parcelas
  installments PaymentInstallment[]

  // ðŸ”¹ Multi-tenant / multi-branch
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  // ðŸ”¹ Auditoria
  createdById String?
  updatedById String?
  createdBy   User?   @relation("PaymentCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("PaymentUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Protocol {
  id           Int     @id @default(autoincrement())
  saleId       Int?    @unique
  sale         Sale?   @relation("SaleProtocol", fields: [saleId], references: [id])
  recordNumber String?
  book         String?
  page         Int?
  os           String?
  isActive     Boolean @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  createdById String?
  updatedById String?
  createdBy   User?   @relation("ProtocolCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("ProtocolUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PaymentInstallment {
  id         Int       @id @default(autoincrement())
  paymentId  Int
  payment    Payment   @relation(fields: [paymentId], references: [id])
  sequence   Int
  amount     Float     @default(0)
  paidAmount Float     @default(0)
  paidAt     DateTime?
  isActive   Boolean   @default(true)

  // ðŸ”¹ Multi-tenant / multi-branch
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  // ðŸ”¹ Auditoria
  createdById String?
  updatedById String?
  createdBy   User?   @relation("PaymentInstallmentCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("PaymentInstallmentUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Role {
  ADMIN
  MANAGER
  EMPLOYEE
}

enum ProductCategory {
  FRAME
  LENS
  ACCESSORY
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum FrameMaterialType {
  ACETATE
  METAL
  RIMLESS
  NYLON
  TITANIUM
  WOOD
  OTHERS
}

enum PaymentMethod {
  PIX
  MONEY
  DEBIT
  CREDIT
  INSTALLMENT
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  CANCELED
}
