datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Tenant {
  id             String           @id @default(cuid())
  name           String
  branches       Branch[]
  users          User[]
  brands         Brand[]
  products       Product[]
  createdById    String?
  updatedById    String?
  createdBy      User?            @relation("TenantCreatedBy", fields: [createdById], references: [id])
  updatedBy      User?            @relation("TenantUpdatedBy", fields: [updatedById], references: [id])
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  OpticalService OpticalService[]
  Client         Client[]
  Prescription   Prescription[]
}

model Branch {
  id             String           @id @default(cuid())
  name           String
  tenantId       String
  tenant         Tenant           @relation(fields: [tenantId], references: [id])
  users          User[]
  createdById    String?
  updatedById    String?
  createdBy      User?            @relation("BranchCreatedBy", fields: [createdById], references: [id])
  updatedBy      User?            @relation("BranchUpdatedBy", fields: [updatedById], references: [id])
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  Product        Product[]
  OpticalService OpticalService[]
  Client         Client[]
  Prescription   Prescription[]

  @@unique([tenantId, name], name: "branch_name_per_tenant_unique")
}

model User {
  id       String  @id @default(cuid())
  name     String
  email    String  @unique
  password String
  role     Role
  tenantId String
  tenant   Tenant  @relation(fields: [tenantId], references: [id])
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id])

  // ðŸ”¹ Auditoria
  createdById String?
  updatedById String?
  createdBy   User?   @relation("UserCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("UserUpdatedBy", fields: [updatedById], references: [id])

  // ðŸ”¹ RelaÃ§Ãµes inversas
  tenantsCreated           Tenant[]         @relation("TenantCreatedBy")
  tenantsUpdated           Tenant[]         @relation("TenantUpdatedBy")
  branchesCreatedByMe      Branch[]         @relation("BranchCreatedBy")
  branchesUpdatedByMe      Branch[]         @relation("BranchUpdatedBy")
  usersCreatedByMe         User[]           @relation("UserCreatedBy")
  usersUpdatedByMe         User[]           @relation("UserUpdatedBy")
  brandsCreatedByMe        Brand[]          @relation("BrandCreatedBy")
  brandsUpdatedByMe        Brand[]          @relation("BrandUpdatedBy")
  productsCreatedByMe      Product[]        @relation("ProductCreatedBy")
  productsUpdatedByMe      Product[]        @relation("ProductUpdatedBy")
  servicesCreatedByMe      OpticalService[] @relation("ServiceCreatedBy")
  servicesUpdatedByMe      OpticalService[] @relation("ServiceUpdatedBy")
  clientsCreatedByMe       Client[]         @relation("ClientCreatedBy")
  clientsUpdatedByMe       Client[]         @relation("ClientUpdatedBy")
  prescriptionsCreatedByMe Prescription[]   @relation("PrescriptionCreatedBy")
  prescriptionsUpdatedByMe Prescription[]   @relation("PrescriptionUpdatedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Brand {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  isActive Boolean   @default(true)
  tenantId String
  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  products Product[]

  // ðŸ”¹ Auditoria
  createdById String?
  updatedById String?
  createdBy   User?   @relation("BrandCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("BrandUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id            Int             @id @default(autoincrement())
  name          String
  description   String?
  costPrice     Float?
  markup        Float?
  salePrice     Float?
  stockQuantity Int?            @default(0)
  minimumStock  Int?            @default(0)
  category      ProductCategory
  isActive      Boolean         @default(true)

  tenantId String
  tenant   Tenant  @relation(fields: [tenantId], references: [id])
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id])
  brandId  Int?
  brand    Brand?  @relation(fields: [brandId], references: [id])

  // ðŸ”¹ Auditoria
  createdById String?
  updatedById String?
  createdBy   User?   @relation("ProductCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("ProductUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OpticalService {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  price       Float
  isActive    Boolean @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  createdById String?
  updatedById String?
  createdBy   User?   @relation("ServiceCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("ServiceUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Client {
  id            Int       @id @default(autoincrement())
  name          String
  nickname      String?
  cpf           String?   @unique
  rg            String?
  bornDate      DateTime?
  gender        Gender?
  fatherName    String?
  motherName    String?
  spouse        String?
  email         String?
  company       String?
  occupation    String?
  street        String?
  number        String?
  neighborhood  String?
  city          String?
  uf            String?
  cep           String?
  complement    String?
  isBlacklisted Boolean?  @default(false)
  obs           String?
  phone01       String?
  phone02       String?
  phone03       String?
  reference01   String?
  reference02   String?
  reference03   String?
  isActive      Boolean   @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  prescriptions Prescription[]

  createdById String?
  updatedById String?
  createdBy   User?   @relation("ClientCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("ClientUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Prescription {
  id Int @id @default(autoincrement())

  clientId Int
  client   Client @relation(fields: [clientId], references: [id])

  prescriptionDate DateTime

  doctorName String?
  crm        String?

  // Olho Direito (OD)
  odSpherical   String?
  odCylindrical String?
  odAxis        String?
  odDnp         String?

  // Olho Esquerdo (OE)
  oeSpherical   String?
  oeCylindrical String?
  oeAxis        String?
  oeDnp         String?

  // Valores independentes
  additionRight      String?
  additionLeft       String?
  opticalCenterRight String?
  opticalCenterLeft  String?

  isActive Boolean @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  createdById String?
  updatedById String?
  createdBy   User?   @relation("PrescriptionCreatedBy", fields: [createdById], references: [id])
  updatedBy   User?   @relation("PrescriptionUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Role {
  ADMIN
  MANAGER
  EMPLOYEE
}

enum ProductCategory {
  FRAME
  LENS
  ACCESSORY
}

enum Gender {
  MALE
  FEMALE
  OTHER
}
